<!doctype html>
<html>
<head>
    <title>CodeWin!</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- ========================================================= -->
<style type="text/css" media="screen">

 /* function try if do for while catch elseif else */
    .function, .do, .for, .while{
      min-width: 300px;
        max-width: 600px;
        margin:5px;
        display: block;
        border-radius: 7px;
    }
    .try, .if, .catch, .elseif, .else{
        min-width: 300px;
        max-width: 600px;
        display: block;
        border-radius: 0px 0px 7px 7px;
    }
    .head{ padding:5px; border-radius: 7px 7px 0px 0px; }


 .try, .catch{        background: #333; color: black; border: thin solid #993d00;}
 .try .head, .catch .head{ background: #333; color: white; border-bottom: : thin solid #993d00;}
 .if, .elseif, .else{ background: #333; color: black; border: thin solid #3366ff;}
 .if .head, .elseif .head, .else .head{ background: #333; color: black; border: thin solid #3366ff;}
 .do{                 background: #001a33; color: white; border: thin solid #001a33;}
 .for{                background: #006666; color: black; border: thin solid #006666;}
 .while{              background: #558000; color: black; border: thin solid #558000;}
 .function{           background:  orange; color: black; border: thin solid orange; }

   .tabBox{ border-radius: 7px; margin:5px; background:  #4d4dff; padding:1px;}
   .tablink{ line-height: 1.4; color: black; background-color: #b3b3ff; border-radius: 7px; padding:3px; margin:3px;}
   .tablink:hover{ background-color: #e6e6ff; border-radius: 7px;}
   .Body{
        color:white;
        background: #333;
        padding:5px;
        border-radius: 0px 0px 7px 7px;
  }
  .end{
    display: none;
  }


</style>
<!-- ========================================================= -->
<div id="code">Hello!</div>
<!-- ========================================================= -->
<script type="text/javascript">
scopes = /\b(module|function|while|do|type|struct|for|if|else|elseif|try|catch|finally|end)\b/g; // omit 'g' to make match act like exec but in array form

var content = ' \n function decodeMessage( msg ) \n String(copy(msg)) \n end \nfunction eval_or_describe_error(strmsg) \n try \n return eval(parse(strmsg, raise = false)) \n catch err \n iob = IOBuffer() \n        dump(iob, err) \n        return String(take!(iob)) \n   end \nend \n \nwsh = WebSocketHandler() do req, client \n    global connections \n    connections[client.id] = client \n    while true \n        val = client |> read |> decodeMessage |> eval_or_describe_error \n        output = String(take!(Base.mystreamvar)) \n        val = val == nothing ? "<br>" : val \n        write(client,"$val<br>$output") \n    end \nend \n';
////////////////////////////////////////////////////////////////////////////////
parse();
////////////////////////////////////////////////////////////////////////////////
function nest(arr, parent) {
    var out = []
    for(var i in arr) {
        if(arr[i].parent == parent) {
            var children = nest(arr, arr[i].id)
            if(children.length) { arr[i].children = children }
            out.push(arr[i])
        }
    }
    return out
}
////////////////////////////////////////////////////////////////////////////////
function parse(){
      var node = document.getElementById("code")
      var parent = node.parentNode

      str = content
node.innerHTML = str;

      m = [{ type: "root", start: 0, id: 0, length: 0 }];
      var match = "";

var index = 1
     while((match = scopes.exec(str)) != null){
            //match = scopes.exec(str); //  alert(match)
            if(match != null){
                m.push( { type: match[1], start: match.index, id: index, length: match[1].length } );
                index++;
            }
      }

// module function while do type struct for ...end
// if elseif else ...end
// try catch finally ...end
 tree = []
 stack = [{type:m[0].type, id:0, parent:0, address: "" }];
//...................................
for (var i = 1; i < m.length; i++) {
        word = m[i].type

        if(stack.length > 0){
          address = stack[stack.length-1].address;
        }else{ address = ""; }


      if(word != "end"){
            if(stack.length > 0){
                  if((stack[stack.length-1].type == "if" || stack[stack.length-1].type == "elseif")
                    && (word == "elseif" || word == "else")){
                        linkAndPop(stack, m, i);
                  }

                  if((stack[stack.length-1].type == "try"  || stack[stack.length-1].type == "catch")
                    && (word == "catch" || word == "finally")){
                        linkAndPop(stack, m, i);
                  }
            }

          stack.push({type:word, id:i,
            parent: (stack[stack.length-1] == undefined)? 0:stack[stack.length-1].id });
      }else{ linkAndPop(stack, m, i); }
}
//...................................

    n = nest(m, 0);
   //alert(  JSON.stringify(n)  )


      var l = m[0].link;
node.innerHTML = '<div class="function">   <div class="head">' +
                  str.slice(n[0].start, n[0].start + n[0].length) + '</div>   <div class="Body">' +
                  str.slice(n[0].start + n[0].length, n[1].start ) + '<div class="end">' +
                  str.slice(n[1].start, n[1].length) + '</div></div>   </div>';

ht = buildComponents(n,0);
node.innerHTML = ht;
function buildComponents(n){
  s = "";
  buf = "";
  tabs = [];
    for (var i = 0; i < n.length; i++) {
      switch (n[i].type) {
        // Component begin
        case "module": s = s +'<div class="module"><div class="head">' +
                str.slice(n[i].start, n[i].start + n[i].length) + '</div><div class="Body">'; break;
        case "function": s = s +'<div class="function"><div class="head">' +
                str.slice(n[i].start, n[i].start + n[i].length) + '</div><div class="Body">'; break;
        case "while": s = s +'<div class="while"><div class="head">' +
                str.slice(n[i].start, n[i].start + n[i].length) + '</div><div class="Body">'; break;
        case "do": s = s +'<div class="do"><div class="head">' +
                str.slice(n[i].start, n[i].start + n[i].length) + '</div><div class="Body">'; break;
        case "for": s = s +'<div class="for"><div class="head">' +
                str.slice(n[i].start, n[i].start + n[i].length) + '</div><div class="Body">'; break;

        // Tablike starters
        case "try": var id = GenerateId(); tabs.push(  {tab:"try", id:id}  );
                buf += '<div id="' + id + '" class="try" style="display:block;"><div class="head">' +
                str.slice(n[i].start, n[i].start + n[i].length) + '</div><div class="Body">';
                break;
        case "if": var id = GenerateId(); tabs.push(  {tab:"if", id:id}  );
                 buf += '<div id="' + id + '" class="if" style="display:block;"><div class="head">' +
                str.slice(n[i].start, n[i].start + n[i].length) + '</div><div class="Body">';
                break;
        // Tablike inner blocks
        case "catch": var id = GenerateId(); tabs.push(  {tab:"catch", id:id}  );
                 buf += '</div></div><div id="' + id + '" class="catch" style="display:none;"><div class="head">' +
                str.slice(n[i].start, n[i].start + n[i].length) + '</div><div class="Body">';
                break;
        case "elseif": var id = GenerateId(); tabs.push(  {tab:"elseif", id:id}  );
                 buf += '</div></div><div id="' + id + '" class="elseif" style="display:none;"><div class="head">' +
                str.slice(n[i].start, n[i].start + n[i].length) + '</div><div class="Body">';
                break;
        case "else": var id = GenerateId(); tabs.push(  {tab:"else", id:id}  );
                 buf += '</div></div><div id="' + id + '" class="else" style="display:none;"><div class="head">' +
                str.slice(n[i].start, n[i].start + n[i].length) + '</div><div class="Body">';
                break; //default:
      }



        // Children insert
        if(n[i].children != undefined) { s = s + buildComponents(n[i].children) }

        // Close component
        if(n[i].type == "end"){                                       // </this></body></funct>

              if(tabs.length){// end of tabbed block
                  s += '<div  class="tabBox">'
                  for (var t in tabs) {
                      s += '<span class="tablink" onclick="openCity(' + tabs[t].id + ', this)" id="'
                      + tabs[t].id + '">' + tabs[t].tab + '</span>'
                  }
                  s += buf;
                  s += '<div class="end">' + str.slice(n[i].start, n[i].length) + '</div></div></div>   </div>';
                  tabs = [];  buf = ""; }
              else{ // end of normal block
                  s += buf + '<div class="end">' + str.slice(n[i].start, n[i].length) + '</div></div></div>';
                  buf = "";
              }

        }else{ // Code (raw)
                if(n[i].start + n[i].length < n[i+1].start){
                  buf += str.slice(n[i].start + n[i].length, n[i+1].start );
                }
        }


     } // end of for loop
     return s;
}

       for (var i = 0; i < m.length; i++) { console.log(i + " " + m[i].id + " " + m[i].type) }
}
////////////////////////////////////////////////////////////////////////////////
function GenerateId(){return "id" + Math.random().toString(16).slice(2);}
////////////////////////////////////////////////////////////////////////////////
function linkAndPop(stack, m, i){
          s = stack.pop();
          if(s == undefined){alert("Warning: structural error in code!")}
            index = s.id;
            //m[index].link = i; // link to end-object
            m[index].parent = s.parent; // link to end

            //m[i].link = index; // link to opening ...just because we can! :)
            m[i].parent = s.parent; // link to opening ...just because we can! :)

}
////////////////////////////////////////////////////////////////////////////////



</script>
<!-- ========================================================= -->
<!-- ========================================================= -->
</head>
<body>


</body></html>
